<!DOCTYPE html>
<html>
<head>
	<title>Distress</title>
	<link rel="stylesheet" type="text/css" href="./distress.css">
</head>
<body>
	<div id="panicButton-container">
		<button id="panicButton-call">Send Distress Call</button>
		<p>Hold the button for 3 seconds to alert a manager</p>
	</div>
	<script type="text/javascript">
		geotab.addin.panicButton = function (api, state) {
			var panicButton = document.getElementById("panicButton-call"),
				panicTimeout = null,
				panicPress = function (event) {
					event.target.classList.add("press");
					panicTimeout = setTimeout(function () {
						var sendEmail = function (results) {
							var subject = api.userName + " in distress",
								body = "I am distressed at " + results[0].formattedAddress,
								emailObj = {
									body: body,
									subject: subject,
									email: "mikemurkovic@geotab.com"
								};

							api.call("SendEmail", emailObj, function(success) {
								alert("Signal sent!");
							}, function (error) {
								alert("Signal not sent!");
							});
						};
						getAddress = function (loc) {
							api.call("GetAddresses", {"coordinates": [{x: loc.coords.longitude, y: loc.coords.latitude}]}, sendEmail);
						};
						event.target.classList.remove("press");

						api.mobile.geolocation.getCurrentPosition(getAddress);
					}, 3000);
				},
				panicStop = function (event) {
					event.target.classList.remove("press");
					clearTimeout(panicTimeout);
				};

			return {
				initialize: function (api, state, callback) {
					panicButton.addEventListener("mousedown", panicPress);
					panicButton.addEventListener("mouseup", panicStop);
				},

				focus: function () {
					console.log("Focus");
				},

				blur: function () {
					console.log("Blur");
				}
			};
		}
	</script>
</body>
</html>