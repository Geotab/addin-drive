<!DOCTYPE html>
<html>
<head>
	<title>Navigator</title>
	<link rel="stylesheet" type="text/css" href="./routes.css">
</head>
<body>
	<div id="navigator-content" class="panel">
		<h3 class="panel-title">Navigate</h3>
		<ul class="menu-list">
			<li data-location="gas stations">
				<a>
					<span>Route</span>
					<select id="routeSelect"><option>Select<option></select>
				</a>
			</li>
			<li class="interest" data-location="gas stations">
				<a><span>Gas stations</span></a>
			</li>
			<li class="interest" data-location="restaurants">
				<a><span>Restaurants</span></a>
			</li>
		</ul>
	</div>

	<script type="text/javascript">
        //TODO: Get device GPS position

        geotab.addin.routes = function (api, state) {

			var currentLocation,
                zones = {},
                routeSelect = document.getElementById("routeSelect"),
                interests = document.getElementsByClassName("interest"),

                getCenterPoint = function(points){
					var sumX = 0, sumY = 0,
							amountOfPoints = points.length, j;

					for (j = 0; j < amountOfPoints; j++){
						sumX += points[j].x;
						sumY += points[j].y;
					}

					return {
						x: sumX / amountOfPoints,
						y: sumY / amountOfPoints
					}
				},

				routeSelectClick = function (e) {
					var select = e.target,
						id = select.options[select.selectedIndex].id;

					// Get the zones
					api.multiCall(zones[id], function (results) {
						var start = results[0][0],
							stop = results[1][0],
							startPoint = getCenterPoint(start.points),
							stopPoint = getCenterPoint(stop.points);

                        window.location.href = "https://maps.google.com/maps?saddr=" + startPoint.y + "," + startPoint.x + "&daddr=" + stopPoint.y + "," + stopPoint.x;
					});
				},

                interestClick = function (e) {
                    var interest = e.currentTarget.dataset.location;
                    window.location.replace("geo:" + currentLocation.latitude + "," + currentLocation.longitude + "?q=" + interest);
                };

            routeSelect.addEventListener("change", routeSelectClick);

            for (var i = 0; i < interests.length; i++) {
                interests[i].addEventListener('click', interestClick, false);
            }

			return {
				initialize: function (api, state, callback) {
					api.call("Get", { typeName: "Route", search: { deviceSearch: { id: "b2" } } }, function (results) {
						if (results.length == 0) {
							return;
						}

						// Add each route to be selectable
						for (var i = 0, j = results.length; i < j; i++) {
							var o = document.createElement("option"),
								calls = [];
							o.id = results[i].id;
							o.innerHTML = results[i].name;
							routeSelect.appendChild(o);

							calls.push([ "Get", { typeName: "Zone", search: { id: results[i].routePlanItemCollection[0].zone.id} } ]);
							calls.push([ "Get", { typeName: "Zone", search: { id: results[i].routePlanItemCollection[1].zone.id} } ]);

							zones[results[i].id] = calls;
						}

						callback();
					});

                    api.device.geolocation.getCurrentPosition(function (location) {
                        currentLocation = location.coords;
                    });
				},

				focus: function () {
				},

				blur: function () {

				}
			};
		}
	</script>
</body>
</html>